<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="SynapseMNIST3D dataset demo">

<title>Image Classification 3D – bioMONAI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Image Classification 3D – bioMONAI">
<meta property="og:description" content="SynapseMNIST3D dataset demo">
<meta property="og:site_name" content="bioMONAI">
<meta name="twitter:title" content="Image Classification 3D – bioMONAI">
<meta name="twitter:description" content="SynapseMNIST3D dataset demo">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">bioMONAI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://deepclem.github.io"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-resources" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Resources</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-resources">    
        <li>
    <a class="dropdown-item" href="https://monai.io/"><i class="bi bi-link" role="img">
</i> 
 <span class="dropdown-text">monai</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://docs.fast.ai"><i class="bi bi-link" role="img">
</i> 
 <span class="dropdown-text">fast.ai</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://fastcore.fast.ai"><i class="bi bi-link" role="img">
</i> 
 <span class="dropdown-text">fastcore</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://fastxtend.benjaminwarner.dev"><i class="bi bi-link" role="img">
</i> 
 <span class="dropdown-text">fastxtend</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://nbdev.fast.ai"><i class="bi bi-link" role="img">
</i> 
 <span class="dropdown-text">nbdev</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/deepCLEM/bioMONAI/issues"><i class="bi bi-bug" role="img">
</i> 
 <span class="dropdown-text">Report an Issue</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/deepCLEM/bioMONAI/"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/"> <i class="bi bi-twitter" role="img" aria-label="Twitter">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Tutorials/tutorial_classification.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../Tutorials/tutorial_classification3d.html">Image Classification 3D</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">bioMONAI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../io.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">I/O</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../losses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loss functions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../nets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Networks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../transforms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transforms</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../callbacks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Callbacks</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../visualize.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualize</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Tutorials/tutorial_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image Classification 2D</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Tutorials/tutorial_classification3d.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Image Classification 3D</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Tutorials/tutorial_denoising.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Denoising</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Tutorials/tutorial_multispectral_classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multispectral Classification</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup-imports" id="toc-setup-imports" class="nav-link active" data-scroll-target="#setup-imports">Setup imports</a></li>
  <li><a href="#download-and-store-the-dataset" id="toc-download-and-store-the-dataset" class="nav-link" data-scroll-target="#download-and-store-the-dataset">Download and store the dataset</a></li>
  <li><a href="#create-dataloader" id="toc-create-dataloader" class="nav-link" data-scroll-target="#create-dataloader">Create Dataloader</a></li>
  <li><a href="#customize-dataloader" id="toc-customize-dataloader" class="nav-link" data-scroll-target="#customize-dataloader">Customize DataLoader</a>
  <ul>
  <li><a href="#parameters" id="toc-parameters" class="nav-link" data-scroll-target="#parameters">Parameters:</a></li>
  <li><a href="#example-usage" id="toc-example-usage" class="nav-link" data-scroll-target="#example-usage">Example Usage:</a></li>
  </ul></li>
  <li><a href="#display-a-batch-of-images" id="toc-display-a-batch-of-images" class="nav-link" data-scroll-target="#display-a-batch-of-images">Display a Batch of Images</a></li>
  <li><a href="#load-and-train-a-3d-model" id="toc-load-and-train-a-3d-model" class="nav-link" data-scroll-target="#load-and-train-a-3d-model">Load and train a 3D model</a></li>
  <li><a href="#train-the-model" id="toc-train-the-model" class="nav-link" data-scroll-target="#train-the-model">Train the Model</a></li>
  <li><a href="#save-the-trained-model" id="toc-save-the-trained-model" class="nav-link" data-scroll-target="#save-the-trained-model">Save the Trained Model</a></li>
  <li><a href="#evaluate-the-model-on-test-data" id="toc-evaluate-the-model-on-test-data" class="nav-link" data-scroll-target="#evaluate-the-model-on-test-data">Evaluate the Model on Test Data</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/deepCLEM/bioMONAI/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Tutorials/tutorial_classification.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../Tutorials/tutorial_classification3d.html">Image Classification 3D</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Image Classification 3D</h1>
</div>

<div>
  <div class="description">
    SynapseMNIST3D dataset demo
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>

<script src="https://static.cloudflareinsights.com/beacon.min.js?token=62f27bdcb8964407a52676798db9edfa" defer=""></script>
<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="setup-imports" class="level3">
<h3 class="anchored" data-anchor-id="setup-imports">Setup imports</h3>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.data <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.transforms <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.core <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.core <span class="im">import</span> Path</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.losses <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.metrics <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.datasets <span class="im">import</span> download_medmnist</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.visualize <span class="im">import</span> show_images_grid, mosaic_image_3d</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bioMONAI.data <span class="im">import</span> get_image_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> get_device()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cuda</code></pre>
</div>
</div>
</section>
<section id="download-and-store-the-dataset" class="level3">
<h3 class="anchored" data-anchor-id="download-and-store-the-dataset">Download and store the dataset</h3>
<p>These lines of code will download the SynapseMNIST3D dataset and set up the paths for training, validation, and test datasets.</p>
<p>The <code>download_medmnist</code> function is used to download the dataset, and the paths are organized to easily access different parts of the dataset for training, validation, and testing purposes. The <code>data_path</code> is updated to point to the ‘synapsemnist3d’ directory, and then separate paths are created for the ‘train’, ‘val’, and ‘test’ subdirectories. This organization helps in easily accessing the different parts of the dataset for training, validation, and testing purposes.</p>
<p>You can customize the <code>data_flag</code> to download different datasets available in the MedMNIST collection. Additionally, you can modify the <code>data_path</code> to change the location where the dataset is stored. If you have a specific directory structure in mind, ensure that the paths for <code>train_path</code>, <code>val_path</code>, and <code>test_path</code> correctly reflect your desired organization. This flexibility allows you to adapt the code to various datasets and storage requirements.</p>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>data_flag <span class="op">=</span> <span class="st">'synapsemnist3d'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">'../_data/medmnist_data/'</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>info <span class="op">=</span> download_medmnist(data_flag, data_path, download_only<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> data_path<span class="op">/</span><span class="st">'synapsemnist3d'</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>train_path <span class="op">=</span> data_path<span class="op">/</span><span class="st">'train'</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>val_path <span class="op">=</span> data_path<span class="op">/</span><span class="st">'val'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>test_path <span class="op">=</span> data_path<span class="op">/</span><span class="st">'test'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading https://zenodo.org/records/10519652/files/synapsemnist3d.npz?download=1 to ../_data/medmnist_data/synapsemnist3d/synapsemnist3d.npz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 38034583/38034583 [00:03&lt;00:00, 11376652.92it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Using downloaded and verified file: ../_data/medmnist_data/synapsemnist3d/synapsemnist3d.npz
Using downloaded and verified file: ../_data/medmnist_data/synapsemnist3d/synapsemnist3d.npz
Saving training images to ../_data/medmnist_data/synapsemnist3d...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1230/1230 [00:00&lt;00:00, 2872.15it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saving validation images to ../_data/medmnist_data/synapsemnist3d...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 177/177 [00:00&lt;00:00, 2822.73it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saving test images to ../_data/medmnist_data/synapsemnist3d...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 352/352 [00:00&lt;00:00, 2847.26it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Removed synapsemnist3d.npz
Datasets downloaded to ../_data/medmnist_data/synapsemnist3d
Dataset info for 'synapsemnist3d': {'python_class': 'SynapseMNIST3D', 'description': 'The SynapseMNIST3D is a new 3D volume dataset to classify whether a synapse is excitatory or inhibitory. It uses a 3D image volume of an adult rat acquired by a multi-beam scanning electron microscope. The original data is of the size 100×100×100um^3 and the resolution 8×8×30nm^3, where a (30um)^3 sub-volume was used in the MitoEM dataset with dense 3D mitochondria instance segmentation labels. Three neuroscience experts segment a pyramidal neuron within the whole volume and proofread all the synapses on this neuron with excitatory/inhibitory labels. For each labeled synaptic location, we crop a 3D volume of 1024×1024×1024nm^3 and resize it into 28×28×28 voxels. Finally, the dataset is randomly split with a ratio of 7:1:2 into training, validation and test set.', 'url': 'https://zenodo.org/records/10519652/files/synapsemnist3d.npz?download=1', 'MD5': '1235b78a3cd6280881dd7850a78eadb6', 'url_64': 'https://zenodo.org/records/10519652/files/synapsemnist3d_64.npz?download=1', 'MD5_64': '43bd14ebf3af9d3dd072446fedc14d5e', 'task': 'binary-class', 'label': {'0': 'inhibitory synapse', '1': 'excitatory synapse'}, 'n_channels': 1, 'n_samples': {'train': 1230, 'val': 177, 'test': 352}, 'license': 'CC BY 4.0'}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="create-dataloader" class="level3">
<h3 class="anchored" data-anchor-id="create-dataloader">Create Dataloader</h3>
</section>
<section id="customize-dataloader" class="level3">
<h3 class="anchored" data-anchor-id="customize-dataloader">Customize DataLoader</h3>
<p>In the next cell, we will create a DataLoader for the SynapseMNIST3D dataset. The <code>BioDataLoaders.class_from_folder</code> function is used to load the dataset from the specified paths and apply transformations to the images.</p>
<p>We will set the batch size to 8 and apply the following transformations: - <code>ScaleIntensity()</code>: Scales the intensity of the images. - <code>RandRot90(prob=0.5, spatial_axes=(1,2))</code>: Randomly rotates the images by 90 degrees with a probability of 0.5 along the specified spatial axes. - <code>Resize(32)</code>: Resizes the images to 32x32x32.</p>
<p>You can customize the DataLoader by changing the batch size, adding or removing transformations, or modifying the paths to the dataset. For example, you can increase the batch size for faster training or add more complex transformations to augment the dataset.</p>
<p>The <code>show_summary</code> parameter is set to <code>True</code> to display a summary of the dataset and transformations applied.</p>
<p>After creating the DataLoader, we will print the number of training and validation images to verify that the dataset has been loaded correctly.</p>
<section id="parameters" class="level4">
<h4 class="anchored" data-anchor-id="parameters">Parameters:</h4>
<ul>
<li><code>data_path</code>: The root directory where the dataset is stored.</li>
<li><code>train</code>: The subdirectory containing the training images.</li>
<li><code>valid</code>: The subdirectory containing the validation images.</li>
<li><code>vocab</code>: The vocabulary or labels for the dataset.</li>
<li><code>item_tfms</code>: A list of transformations to apply to each image individually. Examples include <code>ScaleIntensity()</code>, <code>RandRot90()</code>, and <code>Resize()</code>.</li>
<li><code>batch_tfms</code>: A list of transformations to apply to a batch of images. This can be set to <code>None</code> if no batch transformations are needed.</li>
<li><code>img_cls</code>: The class to use for loading images. For 3D images, this is typically <code>BioImageStack</code>.</li>
<li><code>bs</code>: The batch size, which determines how many images are processed together in each batch.</li>
<li><code>show_summary</code>: A boolean flag to display a summary of the dataset and the transformations applied.</li>
</ul>
</section>
<section id="example-usage" class="level4">
<h4 class="anchored" data-anchor-id="example-usage">Example Usage:</h4>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> BioDataLoaders.class_from_folder(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    data_path,                              <span class="co"># root directory for data</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    train<span class="op">=</span><span class="st">'train'</span>,                          <span class="co"># folder for training data    </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    valid<span class="op">=</span><span class="st">'val'</span>,                            <span class="co"># folder for validation data</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    vocab<span class="op">=</span>info[<span class="st">'label'</span>],                    <span class="co"># list of class labels</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[ScaleIntensity(),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>               RandRot90(prob<span class="op">=</span><span class="fl">0.75</span>, spatial_axes<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>)), </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>               Resize(<span class="dv">32</span>)],                 <span class="co"># transformations to apply to each image</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span><span class="va">None</span>,                        <span class="co"># transformations to apply to each batch</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    img_cls<span class="op">=</span>BioImageStack,                  <span class="co"># class to use for images</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    bs<span class="op">=</span>batch_size,                          <span class="co"># batch size</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    show_summary<span class="op">=</span><span class="va">False</span>,                      <span class="co"># print summary of the data</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># print length of training and validation datasets</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'train images:'</span>, <span class="bu">len</span>(data.train_ds.items), <span class="st">'</span><span class="ch">\n</span><span class="st">validation images:'</span>, <span class="bu">len</span>(data.valid_ds.items))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>train images: 1230 
validation images: 177</code></pre>
</div>
</div>
</section>
</section>
<section id="display-a-batch-of-images" class="level3">
<h3 class="anchored" data-anchor-id="display-a-batch-of-images">Display a Batch of Images</h3>
<p>In the next cell, we will display a batch of images from the training dataset using the <code>show_batch</code> method of the <code>BioDataLoaders</code> class. This method helps visualize the images and their corresponding labels, providing an overview of the dataset.</p>
<p>You can customize the display by modifying the following parameters: - <code>max_n</code>: The maximum number of images to display in the batch. By default, it shows all images in the batch. - <code>nrows</code>: The number of rows to use for displaying the images. This can be adjusted to control the layout of the images. - <code>ncols</code>: The number of columns to use for displaying the images. This can be adjusted to control the layout of the images. - <code>figsize</code>: The size of the figure used to display the images. This can be adjusted to make the images larger or smaller.</p>
<p>For example, you can set <code>max_n=4</code> to display only 4 images from the batch, or set <code>figsize=(10, 10)</code> to increase the size of the displayed images.</p>
<p>This visualization step is useful for verifying that the images have been loaded and transformed correctly before proceeding with model training.</p>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="902_tutorial_classification3D_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="load-and-train-a-3d-model" class="level3">
<h3 class="anchored" data-anchor-id="load-and-train-a-3d-model">Load and train a 3D model</h3>
</section>
<section id="train-the-model" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model">Train the Model</h3>
<p>In the next cell, we will initialize and train a 3D model using the <code>fastTrainer</code> class. The model architecture used is <code>SEResNet50</code>, which is a 3D version of the SE-ResNet50 model. This model is well-suited for 3D image classification tasks.</p>
<p>We will use the following components: - <code>SEResNet50</code>: The model architecture with 3D spatial dimensions, 1 input channel, and 2 output classes. - <code>CrossEntropyLossFlat</code>: The loss function used for training the model. - <code>BalancedAccuracy</code>: The metric used to evaluate the model’s performance. - <code>fastTrainer</code>: A custom trainer class to handle the training process.</p>
<p>The <code>trainer.fit(20)</code> method will train the model for 20 epochs.</p>
<p>You can customize the training process by modifying the following parameters: - <code>model</code>: Change the model architecture to another 3D model, such as <code>DenseNet169</code>. - <code>loss_fn</code>: Use a different loss function, such as <code>FocalLoss</code>. - <code>metrics</code>: Add more metrics to evaluate the model, such as <code>Precision</code> or <code>Recall</code>. - <code>show_summary</code>: Set to <code>False</code> if you do not want to display the model summary. - <code>find_lr</code>: Set to <code>False</code> if you do not want to find the optimal learning rate.</p>
<p>For example, you can add more metrics to the <code>metrics</code> list to get a more comprehensive evaluation of the model’s performance.</p>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> monai.networks.nets <span class="im">import</span> SEResNet50</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> BalancedAccuracy, CrossEntropyLossFlat</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SEResNet50(spatial_dims<span class="op">=</span><span class="dv">3</span>, in_channels<span class="op">=</span><span class="dv">1</span>, num_classes<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> CrossEntropyLossFlat()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>metric <span class="op">=</span> BalancedAccuracy()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> fastTrainer(data, model, loss_fn<span class="op">=</span>loss, metrics<span class="op">=</span>metric, show_summary<span class="op">=</span><span class="va">True</span>, find_lr<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>SEResNet50 (Input shape: 4 x 1 x 32 x 32 x 32)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================
                     4 x 64 x 16 x 16 x  
Conv3d                                    21952      True      
BatchNorm3d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 64 x 8 x 8 x 8  
MaxPool3d                                                      
Conv3d                                    4096       True      
BatchNorm3d                               128        True      
ReLU                                                           
Conv3d                                    110592     True      
BatchNorm3d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 8 x 8 x 8 
Conv3d                                    16384      True      
BatchNorm3d                               512        True      
____________________________________________________________________________
                     4 x 256 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 16              
Linear                                    4112       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256             
Linear                                    4352       True      
Sigmoid                                                        
____________________________________________________________________________
                     4 x 256 x 8 x 8 x 8 
Conv3d                                    16384      True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 64 x 8 x 8 x 8  
Conv3d                                    16384      True      
BatchNorm3d                               128        True      
ReLU                                                           
Conv3d                                    110592     True      
BatchNorm3d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 8 x 8 x 8 
Conv3d                                    16384      True      
BatchNorm3d                               512        True      
____________________________________________________________________________
                     4 x 256 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 16              
Linear                                    4112       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256             
Linear                                    4352       True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 64 x 8 x 8 x 8  
Conv3d                                    16384      True      
BatchNorm3d                               128        True      
ReLU                                                           
Conv3d                                    110592     True      
BatchNorm3d                               128        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 8 x 8 x 8 
Conv3d                                    16384      True      
BatchNorm3d                               512        True      
____________________________________________________________________________
                     4 x 256 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 16              
Linear                                    4112       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256             
Linear                                    4352       True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 128 x 4 x 4 x 4 
Conv3d                                    32768      True      
BatchNorm3d                               256        True      
ReLU                                                           
Conv3d                                    442368     True      
BatchNorm3d                               256        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               1024       True      
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 32              
Linear                                    16416      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512             
Linear                                    16896      True      
Sigmoid                                                        
____________________________________________________________________________
                     4 x 512 x 4 x 4 x 4 
Conv3d                                    131072     True      
BatchNorm3d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 128 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               256        True      
ReLU                                                           
Conv3d                                    442368     True      
BatchNorm3d                               256        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               1024       True      
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 32              
Linear                                    16416      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512             
Linear                                    16896      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 128 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               256        True      
ReLU                                                           
Conv3d                                    442368     True      
BatchNorm3d                               256        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               1024       True      
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 32              
Linear                                    16416      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512             
Linear                                    16896      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 128 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               256        True      
ReLU                                                           
Conv3d                                    442368     True      
BatchNorm3d                               256        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 4 x 4 x 4 
Conv3d                                    65536      True      
BatchNorm3d                               1024       True      
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 32              
Linear                                    16416      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512             
Linear                                    16896      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    131072     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    524288     True      
BatchNorm3d                               2048       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    262144     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    262144     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    262144     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    262144     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 256 x 2 x 2 x 2 
Conv3d                                    262144     True      
BatchNorm3d                               512        True      
ReLU                                                           
Conv3d                                    1769472    True      
BatchNorm3d                               512        True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024 x 2 x 2 x  
Conv3d                                    262144     True      
BatchNorm3d                               2048       True      
____________________________________________________________________________
                     4 x 1024 x 1 x 1 x  
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 64              
Linear                                    65600      True      
ReLU                                                           
____________________________________________________________________________
                     4 x 1024            
Linear                                    66560      True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
Conv3d                                    524288     True      
BatchNorm3d                               1024       True      
ReLU                                                           
Conv3d                                    7077888    True      
BatchNorm3d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048 x 1 x 1 x  
Conv3d                                    1048576    True      
BatchNorm3d                               4096       True      
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 128             
Linear                                    262272     True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048            
Linear                                    264192     True      
Sigmoid                                                        
____________________________________________________________________________
                     4 x 2048 x 1 x 1 x  
Conv3d                                    2097152    True      
BatchNorm3d                               4096       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
Conv3d                                    1048576    True      
BatchNorm3d                               1024       True      
ReLU                                                           
Conv3d                                    7077888    True      
BatchNorm3d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048 x 1 x 1 x  
Conv3d                                    1048576    True      
BatchNorm3d                               4096       True      
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 128             
Linear                                    262272     True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048            
Linear                                    264192     True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
____________________________________________________________________________
                     4 x 512 x 1 x 1 x 1 
Conv3d                                    1048576    True      
BatchNorm3d                               1024       True      
ReLU                                                           
Conv3d                                    7077888    True      
BatchNorm3d                               1024       True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048 x 1 x 1 x  
Conv3d                                    1048576    True      
BatchNorm3d                               4096       True      
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 128             
Linear                                    262272     True      
ReLU                                                           
____________________________________________________________________________
                     4 x 2048            
Linear                                    264192     True      
Sigmoid                                                        
Identity                                                       
ReLU                                                           
AdaptiveAvgPool3d                                              
____________________________________________________________________________
                     4 x 2               
Linear                                    4098       True      
____________________________________________________________________________

Total params: 48,690,162
Total trainable params: 48,690,162
Total non-trainable params: 0

Optimizer used: &lt;function Adam&gt;
Loss function: FlattenedLoss of CrossEntropyLoss()

Callbacks:
  - TrainEvalCallback
  - CastToTensor
  - Recorder
  - ProgressCallback
  - ShowGraphCallback</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>Inferred learning rate:  0.0003</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="902_tutorial_classification3D_files/figure-html/cell-7-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>You can customize the training process by modifying the following parameters: - <code>epochs</code>: Change the number of epochs to train the model for a different duration. For example, you can set it to 50 or 100 epochs. - <code>lr</code>: Adjust the learning rate to control the speed at which the model learns. A lower learning rate can lead to more stable training, while a higher learning rate can speed up the process but may cause instability. - <code>callbacks</code>: Add custom callbacks to monitor the training process, such as early stopping or learning rate schedulers.</p>
<p>For example, you can add an early stopping callback to stop training if the validation loss does not improve for a certain number of epochs. This can help prevent overfitting and save training time.</p>
<p>Additionally, you can experiment with different learning rates to find the optimal value for your dataset. The <code>find_lr</code> parameter in the <code>fastTrainer</code> class can help you automatically find a suitable learning rate.</p>
<p>By customizing these parameters, you can fine-tune the training process to achieve better performance and adapt the model to your specific dataset and requirements.</p>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>trainer.fit(<span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">balanced_accuracy_score</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.737844</td>
<td>0.884683</td>
<td>0.522529</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.668565</td>
<td>0.655822</td>
<td>0.537791</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.661785</td>
<td>0.654336</td>
<td>0.492490</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.691415</td>
<td>0.677920</td>
<td>0.579700</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.656948</td>
<td>0.604279</td>
<td>0.537064</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.592294</td>
<td>0.580940</td>
<td>0.574612</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.622304</td>
<td>0.540016</td>
<td>0.583818</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.567228</td>
<td>0.543166</td>
<td>0.578246</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.611193</td>
<td>0.579035</td>
<td>0.514535</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.592783</td>
<td>0.724594</td>
<td>0.500000</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.547133</td>
<td>0.560082</td>
<td>0.500000</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.574452</td>
<td>0.585088</td>
<td>0.500000</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.566623</td>
<td>0.580101</td>
<td>0.564196</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.619115</td>
<td>0.552885</td>
<td>0.492248</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.554509</td>
<td>0.579128</td>
<td>0.500000</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.575963</td>
<td>0.636180</td>
<td>0.492248</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.539520</td>
<td>0.724575</td>
<td>0.596657</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.574317</td>
<td>0.690074</td>
<td>0.538033</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.524487</td>
<td>0.503385</td>
<td>0.642200</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.538340</td>
<td>0.576844</td>
<td>0.571705</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="902_tutorial_classification3D_files/figure-html/cell-8-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="save-the-trained-model" class="level3">
<h3 class="anchored" data-anchor-id="save-the-trained-model">Save the Trained Model</h3>
<p>In the next cell, we will save the trained model to a file using the <code>save</code> method of the <code>fastTrainer</code> class. This step is important to preserve the trained model so that it can be loaded and used later without retraining.</p>
<p>You can customize the saving process by modifying the following parameters: - <code>file_name</code>: Change the name of the file to save the model with a different name. For example, you can set it to ‘final_model’ or ‘best_model’. - <code>path</code>: Specify a different path to save the model in a different directory. This is useful if you want to organize your saved models in a specific folder.</p>
<p>For example, you can set <code>file_name='final_model'</code> to save the model with the name ‘final_model.pth’, or set <code>path='../models/'</code> to save the model in the ‘models’ directory.</p>
<p>By customizing these parameters, you can ensure that the model is saved with a meaningful name and in an organized manner, making it easier to manage and retrieve the model for future use.</p>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trainer.save('tmp-model')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluate-the-model-on-test-data" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-the-model-on-test-data">Evaluate the Model on Test Data</h3>
<p>Here, we will evaluate the performance of the trained model on the test dataset. This step is crucial to understand how well the model generalizes to unseen data.</p>
<p>We will use the <code>data.test_dl</code> method to create a DataLoader for the test dataset. The <code>get_image_files</code> function is used to retrieve the test images from the specified path. The <code>with_labels=True</code> parameter ensures that the test images are loaded with their corresponding labels.</p>
<p>After creating the test DataLoader, we will print the number of test images to verify that the dataset has been loaded correctly.</p>
<p>You can customize the evaluation process by modifying the following parameters: - <code>test_path</code>: Change the path to the test dataset if it is stored in a different location. - <code>with_labels</code>: Set to <code>False</code> if the test dataset does not have labels. This is useful for evaluating the model on unlabeled data. - <code>batch_size</code>: Adjust the batch size for the test DataLoader. A larger batch size can speed up the evaluation process but may require more memory.</p>
<p>By customizing these parameters, you can adapt the evaluation process to different datasets and requirements, ensuring that the model’s performance is accurately assessed.</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> data.test_dl(get_image_files(test_path), with_labels<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print length of test dataset</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'test images:'</span>, <span class="bu">len</span>(test_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>test images: 88</code></pre>
</div>
</div>
<p>In the next cell, we will evaluate the performance of the trained model on the test dataset using the <code>evaluate_classification_model</code> function. This function will compute various evaluation metrics and display the results.</p>
<p>You can customize the evaluation process by modifying the following parameters: - <code>show_graph</code>: Set to <code>True</code> to display a graph of the evaluation metrics. This can help visualize the model’s performance. - <code>show_results</code>: Set to <code>True</code> to display the results of the evaluation, including the predicted labels and ground truth labels.</p>
<p>For example, you can set <code>show_graph=True</code> to visualize the evaluation metrics, or set <code>show_results=True</code> to see the detailed results of the evaluation.</p>
<p>By customizing these parameters, you can gain a deeper understanding of the model’s performance and identify areas for improvement. This step is crucial for fine-tuning the model and ensuring that it generalizes well to unseen data.</p>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>evaluate_classification_model(trainer, test_data, show_graph<span class="op">=</span><span class="va">False</span>, show_results<span class="op">=</span><span class="va">False</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="88" style="width:300px; height:20px; vertical-align: middle;"></progress>
      0.00% [0/88 00:00&lt;?]
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

           0       0.69      0.12      0.20        95
           1       0.75      0.98      0.85       257

    accuracy                           0.75       352
   macro avg       0.72      0.55      0.52       352
weighted avg       0.73      0.75      0.67       352


Most Confused Classes:</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>[('0', '1', 84), ('1', '0', 5)]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Value</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">CrossEntropyLossFlat</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mean</td>
<td>0.581597</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Median</td>
<td>0.453715</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Standard Deviation</td>
<td>0.254455</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Min</td>
<td>0.314898</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Max</td>
<td>1.300359</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Q1</td>
<td>0.398424</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Q3</td>
<td>0.711500</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="902_tutorial_classification3D_files/figure-html/cell-11-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/deepCLEM\.github\.io\/bioMONAI");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright © 2024 Biagio Mandracchia, MIT License</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/deepCLEM/bioMONAI/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/deepCLEM/bioMONAI/">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>